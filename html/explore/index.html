
{% load i18n %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">  
  {% if displayviz %}
  <meta property="og:image" content="http://atlas.cid.harvard.edu{{ displayImage }}"/>
  {% else %}
  <meta property="og:image" content="http://atlas.cid.harvard.edu/media/img/empty_static_200x200.png"/>
  {% endif %}  
  <meta name="twitter:card" content="photo">
  <meta name="twitter:site" content="@romsson">
  <meta name="twitter:creator" content="@romsson">
  <meta name="twitter:title" content="{% if title %}{{title}} @Atlas_facts {% else %} The Atlas Of Economic Complexity {% endif %}">
  {% if displayviz %}
  <meta name="twitter:image:src" content="http://atlas.cid.harvard.edu{{ displayImage }}"/>
  {% else %}
  <meta name="twitter:image:src" content="http://atlas.cid.harvard.edu/media/img/empty_static_200x200.png"/>
  {% endif %} 
  <meta name="twitter:domain" content="http://www.atlas.cid.harvard.edu/">
  <base href="{{HTTP_HOST}}">
  <title>The Atlas Of Economic Complexity{% if title %} | {{title}}{% else %}{% endif %}</title>
  <meta name="description" content="Networks in Macro Economics with World Trade Data">
  <!-- The Atlas Of Economic Complexity | ({% if year_start %}{{year_start}} - {{year_end}}{% else %}{{year}}{% endif %})
  <!-- Necessary for google to crawl the site, since it is purely ajax based.
        When the crawler reaches the page it will request the current URL plus
        the additional URL query parameter _escaped_fragment_= -->
  <meta name="fragment" content="!">
  
  <link rel="shortcut icon" type="image/x-icon" href="{{ STATIC_URL }}img/favicon.ico">
  <!-- Load non-standard fonts -->
  <link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow' rel='stylesheet' type='text/css' />
  <link href='http://fonts.googleapis.com/css?family=Cardo' rel='stylesheet' type='text/css' />
  
  <link rel="stylesheet" href="{{ STATIC_URL }}js/libs/bootstrap/css/bootstrap.css"/>
  <link rel="stylesheet" href="{{ STATIC_URL }}css/normalize.css">
  <link rel="stylesheet" href="{{ STATIC_URL }}css/style.css?{{ VERSION }}">
  <link rel="stylesheet" href="{{ STATIC_URL }}js/libs/toastr/toastr.min.css" />
  <link rel="stylesheet" href="{{ STATIC_URL }}js/libs/chosen/chosen.css" />
  <link rel="stylesheet" href="{{ STATIC_URL }}js/libs/vizwiz/src/utils.slider.css?{{ VERSION }}" />
  <link rel="stylesheet" href="{{ STATIC_URL }}js/libs/bootstro/bootstro.min.css"/>
  <link rel='stylesheet' type='text/css' href='../media/js/libs/tipsy/tipsy.css'>

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">  

  <link rel="stylesheet" href="{{ STATIC_URL }}css/countries.css?{{ VERSION }}" />

  <link rel="stylesheet" href="{{ STATIC_URL }}js/libs/jquery-ui/jquery-ui.css" type="text/css" media="all" />
  <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/widgets.css?{{ VERSION }}">
  <!-- VizWiz -->

  <link href="{{ STATIC_URL }}js/libs/vizwiz/src/vizwhiz.d3.css" rel="stylesheet" type="text/css"> 
  
  <link href="{{ STATIC_URL }}js/libs/d3plus/d3plus.css" rel="stylesheet" type="text/css"> 

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>
<body class="app" >
  {% if alert %}
  <div class="alert">
    <div>
      {% if alert.title %}
      <h4>{{alert.title}}</h4>
      {% endif %}
      {% if alert.text %}{{alert.text|safe}}{% endif %}
    </div>
  </div>
  {% endif %}
  {% if warning %}
  <div class="warning">
    <div>
      {% if warning.title %}
      <h4>{{warning.title}}</h4>
      {% endif %}
      {% if warning.text %}{{warning.text|safe}}{% endif %}
    </div>
  </div>
  {% endif %}
  <div id="container">
    <header>
     <div class="logo" style="background-color: #fafafa; width:165px; height:66px;">
        <a href="" title="Home" style="text-decoration: none;">
        <h1 style="background: url({{ STATIC_URL }}img/all/logo_rainbow.png) repeat-x 100% 100%; padding-bottom:22px; color: black; font-size:43px;">The Atlas</h1>
        <h2 style="font-size:14px; margin-top:-25px; text-align:center; margin-left:0px; letter-spacing:1px; color:white; text-transform:uppercase; text-decoration:none; background-color: #a0a6a9;">of Economic Complexity</h2></a> 
      </div>  
      <nav>
        <ul>
          <li><a {% if isbrowsemode %}href="endbrowse"{% else %}href="explore"{% endif %}>Explore</a></li>
          <li><a href="stories">Stories</a></li>
          <li><a href="rankings">Rankings</a></li>
          <li><a id="newBook" href="book">New Book</a></li>
          <li><a href="about">About</a></li>
        </ul>
      </nav> 
      <br class="clear">
    </header>
    
    <div id="main" role="main">
      {% if userId %}
       <div id="userSession">
       	 <button id="logoutBtn"  onclick="location.href='logout/'" style="font-family: inherit;">Logout</button>	
       	 <p id="loggedInUser">Hello {{ userName }}</p> 
       </div>
       {% endif %}
      <div class="app_title" id="icons" style="width:230px; height:60px; margin-left:10px;">
        
      <script>
		
      var list_viz = ["tree_map", "map", "stacked", "product_space", "pie_scatter", "rings", "scatterplot", "rankings"];
      var dev = {% if DEV %}true{% else %}false{% endif %}; // Variable used mostly to be more verbose for debug

      </script>
     
        <ul class="nav nav-tabs" id="myTab">
          <li class="active"><a href="#tab-countries"><span class="glyphicon glyphicon-globe"></span>  <span style="font-size:18px;">World Data</span></a></li>
        </ul>

      </div>

      <!-- The title -->
      <div class="app_title" id="title">
        <h2 style="margin-left:10px; width:700px;" id="text_title">{% if title %}{{title}}{% else %}&nbsp;{% endif %}</h2>
      </div>
      
      <br style="clear:both">
  	 {% if isbrowsemode %}
  	 {% else %}

      <!-- The left pane -->
      <div id="app_pane" style="width:230px; height:810px;">
        <div data-toggle="tooltip" class="tab-content bootstro" data-bootstro-title="Query" data-bootstro-content="The first thing you need to do is decide what question you are trying to answer. Perhaps, what products did the United States export in 2000? Or how has its import basket changed in the last ten years?  Once you have decided your query, you can enter the information you need to answer this in the left-hand bar." data-bootstro-placement="right">

          <!-- Country selection -->
          <div class="tab-pane active" id="tab-countries">
            <span title="0 void" toolTip="2" style="margin:10px 0px; font-weight:bold;">Select a Country:</span>
            <div id="country1" width="120px" style="margin-left: 0px;" onmouseover="$('.show-partner').css('visibility', 'visible');"  onmouseout="$('.show-partner').css('visibility', 'hidden');">

              <button type="button" onclick="update_viz()" class="glyphicon glyphicon-refresh show-partner tooltipbs" data-toggle="tooltip" title="Refresh" data-placement="top" style="float:right; margin-right:10px; width:25px; height:20px; font-size:8px; visibility:hidden;"></button>

                <select data-placeholder="All Countries" id="country1_select" class="chosen-select-deselect" tabindex="-1" style="display: none;">

                <option value=""></option>
                  {% if country1_list %}
                    {% for c in country1_list %}
                      {% if c.id == country1.id %}
                      <option value="{{c.name_3char|lower}}" selected="selected">{{ c.name }}</option>
                      {% else %}
                      <option value="{{c.name_3char|lower}}">{{ c.name }}</option>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    {% include "explore/list_countries.html" %}
                  {% endif %}
              </select>
            </div>

          <ul class="nav nav-tabs main-countries-products" id="myTab" style="width:210px; margin-top:20px">
            <li {% if app_name != "product_space" and app_name != "pie_scatter" and app_name != "rings"  %}class="active"{% endif %}><a href="#tab-trade"> <span class="glyphicon glyphicon-resize-horizontal"></span> <span style="font-size:14px;" title='{% trans "Trade Flow" %}'>{% trans "Trade Flow" %}</span></a></li>
            <li {% if app_name == "product_space" or app_name == "pie_scatter" or app_name == "rings" %}class="active"{% endif %}><a href="#tab-diversification"><span style="font-size:14px; color:gray;">Diversification</span></a></li>
          </ul>

        <!-- TRADE / DIVERSIFICATION -->
        <div class="tab-content"  style="height:50px; border: solid 1px #e6e6e6; border-top: 0px; padding-top:10px; width:210px; height:335px;">

          <!-- Country selection -->
          <div class="tab-pane {% if app_name != "product_space" and app_name != "pie_scatter" and app_name != "rings" %}active{% endif %}" id="tab-trade">

          <div id="trade_flow" style="margin-left: 8px;">

            <div class="btn-group flow-direction" data-toggle="buttons" style="margin-top:5px; margin-left:5px">
              <label class="btn btn-default {% if trade_flow == "export" or trade_flow == "net_export" %} active{% endif %}">
                <input type="radio" name="flow_direction" value="export" onchange="$('.flow-direction').children().eq(1).removeClass('active'); $(this).parent().addClass('active');update_viz();"><i style="padding:0;"class="fa fa-sign-out"></i>&nbsp;&nbsp;Export&nbsp;
              </label>
              <label class="btn btn-default {% if trade_flow == "import" or trade_flow == "net_import" %} active{% endif %}">
                <input type="radio" name="flow_direction" id="flow_direction" value="import" onchange="$('.flow-direction').children().eq(0).removeClass('active'); $(this).parent().addClass('active');update_viz();"><i style="padding:0;" class="fa fa-sign-in fa-flip-horizontal"></i>&nbsp;&nbsp;Import&nbsp;
              </label>
            </div>
          </div>
       
          <ul class="nav nav-tabs tab-trade-partner-product" id="myTab" style="margin-top: 20px; margin-left:10px; width:190px;">
            <li{% if prod_or_partner == "product" %} class="active"{% endif %}><a href="#show-country-product"><span class="glyphicon glyphicon-barcode" style="font-size:14px; color:gray;"></span>  <span style="font-size:14px; color:gray;">Product</span></a></li>
            <li{% if prod_or_partner == "partner" %} class="active"{% endif %}><a href="#show-country-partner"><span class="glyphicon glyphicon-globe" style="font-size:14px; color:gray;"></span> <span style="font-size:14px;">Partner</span></a></li>
          </ul>

          <!-- Tab Trade Partner/Product -->
          <div class="tab-content" style="height:50px; border: solid 1px #e6e6e6; border-top: 0px; padding-top:10px; width:190px; margin-left:10px; height:60px">
          
            <div class="tab-pane {% if prod_or_partner == "product" %} active{% endif %}" id="show-country-product">

              <div id="country-product" width="120px" style="margin-left:10px;"  onmouseover="$('.show-country-product').css('visibility', 'visible');"  onmouseout="$('.show-country-product').css('visibility', 'hidden');">
          
                <button type="button" onclick="update_viz();" class="glyphicon glyphicon-refresh show-country-product tooltipbs"  data-toggle="tooltip" title="Refresh" data-placement="top" style="float:right; margin-right:10px; width:25px; height:20px; font-size:8px; visibility:hidden;"></button>

                <select data-placeholder="All Products" id="country_product_select" class="chosen-select-deselect" tabindex="-1" style="display: none;">
                  <option value=""></option>
                  {% if product_list %}
                    {% for p in product_list %}
                      {% if p.id == product.id %}
                    <option value="{{p.code}}" selected="selected">{{ p.name }}</option>
                      {% else %}
                    <option value="{{p.code}}">{{ p.name }}</option>
                      {% endif %}   
                    {% endfor %}
                  {% else %}  
                    {% with "explore/list_products_"|add:prod_class|add:".html" as template %}
                    {% include template %}
                    {% endwith %}
                  {% endif %}                          
                </select>
              </div>
            </div>

            <div class="tab-pane {% if prod_or_partner == "partner" %} active{% endif %}" id="show-country-partner">

              <div id="country-trade-partner" style="margin-left: 10px;" onmouseover="$('.show-trade-partner').css('visibility', 'visible');" onmouseout="$('.show-trade-partner').css('visibility', 'hidden');">

                 <button type="button" onclick="update_viz();" class="glyphicon glyphicon-refresh show-trade-partner tooltipbs"  data-toggle="tooltip" title="Refresh" data-placement="top" style="float:right; margin-right:10px; width:25px; height:20px; font-size:8px; visibility:hidden;"></button>

                  <select data-placeholder="All Countries" id="country_trade_partner_select" class="chosen-select-deselect" tabindex="-1" style="display: none;">
                    <option value=""></option>
                    {% if country1_list %}

                    {% for c in country1_list %}
                      {% if c.id == country2.id %}
                      <option value="{{c.name_3char|lower}}" selected>{{ c.name }}</option>
                      {% else %}
                      <option value="{{c.name_3char|lower}}">{{ c.name }}</option>
                      {% endif %}
                    {% endfor %}

                  {% else %}

                    {% include "explore/list_countries.html" %}

                  {% endif %}

                  </select>
              </div>
            </div>
          </div>
  
          <!-- App selection -->
          <div style="font-weight:bold; margin-top:0px; margin-left:10px">
          <br>
          Visualization:</div>

          <div id="tfViz" data-toggle="buttons" style="margin-left:5px;">

            <label value="tree_map" class="btn btn-default {% if app_name == 'tree_map' %}active{% endif %} tooltipbs" data-placement="top" data-toggle="tooltip" title="Treemap" >

              <input type="radio" style="background:url({{ STATIC_URL }}img/home/treeMap-thumb.png) no-repeat;"> <img src="{{ STATIC_URL }}img/home/treeMap-thumb.png" style="width:38px;"/>
            </label>
            <label value="map" class="btn btn-default {% if app_name == 'map' %}active{% endif %}" data-placement="top" data-toggle="tooltip" title="Map" >
               <input type="radio" style="background:url({{ STATIC_URL }}img/home/geo-thumb.png) no-repeat;"> <img src="{{ STATIC_URL }}img/home/geo-thumb.png" style="width:38px;"/>
            </label>
            <label value="stacked" class="btn btn-default {% if year_interval_list %}active{%endif%} tooltipbs" data-placement="top" data-toggle="tooltip" title="Stacked Graph" >
              <input type="radio" name="viz_apps"> <img src="{{ STATIC_URL }}img/home/stacked-thumb.png" style="width:38px;"/>

            </label>

            {% if app_name == 'scatterplot' or app_name == 'rankings' %}
              <label value="scatterplot" class="btn btn-default {% if app_name == 'scatterplot' %}active{% endif %}" data-placement="top" data-toggle="tooltip" title="Scatter Plot" >
              <input type="radio" name="viz_apps"> <img src="{{ STATIC_URL }}img/home/scatterplot-thumb.png" style="width:38px;"/>
              </label>

              <label value="rankings" class="btn btn-default {% if app_name == 'rankings' %}active{% endif %}" data-placement="top" data-toggle="tooltip" title="Rankings" >
              <input type="radio" name="viz_apps"> <img src="{{ STATIC_URL }}img/home/rankings-thumb.png" style="width:38px;"/>
              </label>
            {% endif %}
          </div>

          </div>

          <!-- Diversification TAB -->
          <div class="tab-pane {% if app_name == "product_space" or app_name == "pie_scatter" or app_name == "rings" %}active{% endif %}" id="tab-diversification" style="text-align:left; padding:0 25px">
            <p>Visualization:</p>
            <div  id="div_apps" data-toggle="buttons" style="margin-top:10px;">
                  

            <button value="product_space" type="radio"  title="A map of technological relatedness" toolTip="0" class="divBtn btn btn-default {% if app_name == "product_space" %}active{% endif %}" onclick="update_viz('product_space');">


                <img src="{{ STATIC_URL }}img/home/productSpace-thumb.png" style="height:35px; width:35px;">
          

                <p style="display:inline;">Product Space</p>
              </button>

              <p style="clear:both"></p><br>


              <button title="Opportunities for a country to diversify and potential gains" value="pie_scatter" type="radio" class="divBtn btn btn-default {% if app_name == "pie_scatter" %}active{% endif %}"onclick="update_viz('pie_scatter');">


                <img src="{{ STATIC_URL }}img/home/productFeas2-thumb.png" style="height:35px; width:35px">
          

                <p style="display:inline;">Product Feasability</p>

              </button>

              {% if app_name == "rings" %}
              <p style="clear:both"></p><br>

              <button title="Product-centric navigation of the Product Space" value="rings" type="radio" class="divBtn btn btn-default {% if app_name == "rings" %}active{% endif %}"onclick="update_viz('rings');">


                <img src="{{ STATIC_URL }}img/home/rings-thumb.png" style="height:35px; width:35px">
          

                <p style="display:inline;">Rings</p>
              </button>

              {% endif %}

            </div>
               
            <br><br>

          </div>
        </div>
      </div>

    <!-- Product Tab -->
    <div class="tab-pane " id="tab-products">
      <b style="margin:10px 0px">Select a Product:</b>
      <div class="dropdown_container" id="product" width="120px" style="margin-left: 10px;" onmouseover="$('.show-product').css('visibility', 'visible');"  onmouseout="$('.show-product').css('visibility', 'hidden');">

        <button type="button" onclick="update_viz()" class="glyphicon glyphicon-refresh show-product" style="float:right; margin-right:10px; width:25px; height:20px; font-size:8px; visibility:hidden;"></button>

        <select>
         <option value=""></option>
          {% if product_list %}
            {% for p in product_list %}
              {% if p.id == product.id %}
            <option value="{{p.code}}" selected="selected">{{ p.name }}</option>
              {% else %}
            <option value="{{p.code}}">{{ p.name }}</option>
              {% endif %}   
            {% endfor %}
          {% else %}  
            {% with "explore/list_products_"|add:prod_class|add:".html" as template %}
            {% include template %}
            {% endwith %}
          {% endif %}  
      </div>

      <!-- Product Trade Flow -->
      <div style="margin-left: 15p; margin-top:20px; font-weight:bold;">Select a <span class="definition">{% trans "Trade Flow" %}:</div>

      <div class="dropdown_container" id="product-trade-flow" width="120px" style="margin-left: 10px;" onmouseover="$('.show-trade-flow').css('visibility', 'visible');"  onmouseout="$('.show-trade-flow').css('visibility', 'hidden');">
            
      <button type="button" onclick="update_viz()" class="glyphicon glyphicon-refresh show-trade-flow" style="float:right; margin-right:10px; width:25px; height:20px; font-size:8px; visibility:hidden;"></button>

        <select data-url_pos="5">
          {% for tf in trade_flow_list %}
          {% if tf.0 == trade_flow %}
          <option value="{{tf.0}}" selected="selected">{{ tf.1 }}</option>
          {% else %}
          <option value="{{tf.0}}">{{ tf.1 }}</option>
          {% endif %}
          {% endfor %}
        </select>

      </div>

      <ul class="nav nav-tabs tab-trade-partner-product" id="myTab" style="margin-top: 20px">
        <li class="active"><a href="#show-country-partner"><span style="font-size:16px;" class="definition">Country</span></a></li>
      </ul>

          <!-- Tab Trade Partner/Product -->
          <div class="tab-content" style="height:50px; border: solid 1px #e6e6e6; border-top: 0px; padding-top:10px">

            <div class="tab-pane active" id="show-country-product">

              <div id="country-product" width="120px" style="margin-left:10px;"  onmouseover="$('.show-country-product').css('visibility', 'visible');"  onmouseout="$('.show-country-product').css('visibility', 'hidden');">
          
                <button type="button" onclick="update_viz();" class="glyphicon glyphicon-refresh show-country-product" style="float:right; margin-right:10px; width:25px; height:20px; font-size:8px; visibility:hidden;"></button>

                <select data-placeholder="All Countries" class="chosen-select-deselect" tabindex="-1" style="display: none;" id="products_country1_select">
                    <option value=""></option>
                    {% if country1_list %}{% for c in country1_list %}
                      {% if c.id == country1.id %}<option value="{{c.name_3char|lower}}" selected="selected">{{ c.name }}</option>
                    {% else %}
                    <option value="{{c.name_3char|lower}}">{{ c.name }}</option>
                    {% endif %}
                    {% endfor %}  
                  {% else %}
                    {% include "explore/list_countries.html" %}
                  {% endif %}
                </select>
              </div>
            </div>
          </div>

    </div> <!-- End Product Tab -->
  
  <!-- END -->
  </div>

  <!-- Year tab -->
   <div class="tab-content" style="display:block">
    <ul class="nav nav-tabs" id="myTab">
      <li class="active"><a href="#country-year"><span class="glyphicon glyphicon-calendar"></span> <span style="font-size:16px;">Time Period</span></a></li>
    </ul>

    <div class="tab-content" style="height:50px; border: solid 1px #e6e6e6; border-top: 0px; padding-top:10px;"  onmouseover="$('.over-time').css('visibility', 'visible');"  onmouseout="$('.over-time').css('visibility', 'hidden');">

      <div class="tab-pane active" id="country-year">

        <button type="button" onclick="update_viz();" class="glyphicon glyphicon-refresh over-time tooltipbs"  data-toggle="tooltip" title="Refresh" data-placement="top"style="float:right; margin-right:10px; width:25px; height:20px; font-size:8px; visibility:hidden;"></button>

        <div id="year1" style="float:left; margin-left:10px;">
           <select data-url_pos="5" id="year1_select" class="chosen-select-deselect" data-placeholder="All Countries" style="width:80px;">
            {% for y in year1_list %}
            {% if y == year or y == year_start %}
            <option value="{{y}}" selected="selected">{{ y }}</option>
            {% else %}
            <option value="{{y}}">{{ y }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>

        <div id="year2" style="float:left; margin-left:10px;">
          <select data-placeholder="End" class="chosen-select-deselect" id="year2_select" tabindex="-1" style="display: none;">
            <option value=""></option>
            {% for y in year1_list %}
            {% if y == year_end %}
            <option value="{{y}}" selected="selected">{{ y }}</option>
            {% else %}
            <option value="{{y}}">{{ y }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>

<!--       <div class="tab-pane" id="country-over-time">

        <div class="product_class" style="float:left; margin-left:10px;">
           <select data-url_pos="5" id="year1_select" style="width:80px">
            {% for y in year1_list %}
            {% if y == year or y == year_start %}
            <option value="{{y}}" selected="selected">{{ y }}</option>
            {% else %}
            <option value="{{y}}">{{ y }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="product_class" style="float:left; margin-left:10px;">
           <select data-url_pos="5" id="year1_select" style="width:80px">
            {% for y in year1_list %}
            {% if y == year or y == year_start %}
            <option value="{{y}}" selected="selected">{{ y }}</option>
            {% else %}
            <option value="{{y}}">{{ y }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>

      </div> -->
    </div>
</div>
<ul style="margin-bottom:0px; padding-bottom:0px;" class="nav nav-tabs">
  <li id="helpTab" {% if app_name != "product_space" and app_name != "pie_scatter" %}class="active"{% endif %}><a href="#helpPane" data-toggle="tab">Help</a></li>

  {% if previous_page != "http://atlas.cid.harvard.edu/" and previous_page != "http://127.0.0.1:8000/" and previous_page != "None" %}
  <li id="historyTab"><a href="#history" data-toggle="tab">History</a></li>
  {% endif %}

  {% if app_name == "product_space" or app_name == "pie_scatter" %}
    <li class="active" id="legendTab"><a href="#legendPane" data-toggle="tab">Legend</a></li>
  {% endif %}
</ul>
<div class="tab-content" style="padding-top:0px;">
  <div class="tab-pane {% if app_name != "product_space" and app_name != "pie_scatter" %}active{% endif %}" id="helpPane">
    <div class="bootstro" data-bootstro-title="Help Box" data-bootstro-content="If you're curious about anything on the page, simply move your mouse over it and the Help Box will display useful information. If you need more information, use the “About” tab at the top of the page." data-toggle="tooltip" data-bootstro-placement="right" id="helpBox">
      <div id="helpBoxInner">
          <h3> </h3>
          <hr>
          <p>Welcome to The Atlas of Economic Complexity. Hover over an element to see its function.</p>
      </div>
      <button id="help">{% trans "Help" %}</button>
    </div>
  </div>
  <div class="tab-pane" id="history">
    <div id="historyBox">
      <div id="historyBoxInner">
        <a href="#"><i id="hnLeft" class="fa fa-chevron-left historyNav"></i></a>
        <a id="historySlide"></a>
        <a href="#"><i id="hnRight" class="fa fa-chevron-right historyNav"></i></a>
      </div>
    </div>
  </div>
  {% if app_name == "product_space" or app_name == "pie_scatter" %}
    <div class="tab-pane active" id="legendPane">
      <div id="legend">
        <ul>
        {% if app_name == "product_space" %}
          <li>
            <span><div id="legendComm"></div></span>
            <span><p>  = Product Community</p></span>
          </li>
          <li>
            <span><div id="legendConn"></div></span>
            <span><p>  = Link between Product Communities</p></span>
          </li>
        {% else %}
          <li>
            <span><div id="legendComm"></div></span>
            <span><p>  = Product Community (RCA > 1)</p></span>
          </li>
          <li>
            <span><div id="legendComm1"></div></span>
            <span><p>  = Product Community (RCA < 1)</p></span>
          </li>

          <!-- ADD PIE CHART HERE!!!! -->                        

        {% endif %}
        </ul>
      </div>
    </div>
    {% endif %}
  </div>
</div> <!-- END app selection pane -->
{% endif %}
      <!-- the Visualization -->
    {% if isbrowsemode %}
    <div id="content" style="width: 95%; min-height:765px;">
			<div style="margin-left: 20px; width: 75%; float:left">
				<h2>{{ browseStoryName }}</h2>
				<p>{{ browseStoryDesc }}</p>
			</div>
			<div style="float:right;margin-right: 20px;margin-top: 20px;">
				<button id="endrstory" class="endbstory" 
				onclick="location.href='endbrowsestory/',clearLocalStorage()">Exit</button>
			</div>
			<div style="clear:both"></div>
        <!-- ajax loading gif -->
        <div id="loader">
          <img src="{{ STATIC_URL }}img/all/loader.gif" alt="loading" /><br />Loading...
        </div>
        
        <!-- the canvas for the visualization -->
        <div id="text_data">

        </div>
        
        <!-- Container for the visualization -->
        <div  id="viz" style="width: 100%; min-height:520px"></div>
        
        <!-- Container for the key/legend -->
        <div class="key {{prod_class}}" style="min-height:50px"></div>
			<div style="margin-left: 20px; width: 80%;">
				<h3 style="margin-bottom: 0px;">{{ browseChapterName }}</h3>
				<p>{{ browseChapterDesc }}</p>
			</div>
		<div class="BrowseNextPrev">
				<div style="clear: both;"></div>
				<button id="BrowsePrev" class="BrowsePrev" onclick="checkChapterCount(-1)">Prev</button>	
				<button id="BrowseNext" class="BrowseNext" onclick="checkChapterCount(1)">Next</button> 
				{% if userId %}
				<a><img src="{{ STATIC_URL }}img/app/like.png" id="likeImage" alt="like" /></a>
                   <h3 id="likeCount">{{likeCount}} Likes</h3>
				{% endif %}	
		</div> 
</div>      
    {% else %}
      <div id="content"  class="container" style="width: 750px; min-height:600px;">
        <div class="contentViz">
        <!-- ajax loading gif -->
          <div id="loader">
          <!--if static image mode is PNG-->
          {% if displayviz %}
            <img src="{{ displayImage }}" alt="loading" style="width: 750px; height:520px; margin-top:-150px; opacity:.7"/><br />
            <span style="width: 750px; height:520px; margin-top:-550px; opacity:.7">Loading...</span>
          {% else %}
  	         <img src="{{ displayImage }}" alt="loading"/><br />
          {% endif %}
          </div>
          
          <!-- the canvas for the visualization -->
          <div id="text_data"></div>
          <div id="historyOverlay"></div>
          <!-- Container for the visualization -->
          <div class="bootstro" data-bootstro-title="Visualization" data-bootstro-content="The visualization will appear here based off the query you implemented and application you chose." data-toggle="tooltip" data-bootstro-placement="left"id="viz" style="width:750px;min-height:520px;">
          </div>  
		  </div>
        <div class="contentInner">
        <!-- Container for the key/legend -->
        <div class="key {{prod_class}}" style="min-height:50px"></div>
        <!-- Container for the timeline -->
         <div id="timeline" class="bootstro" data-bootstro-title="Options Panel" data-bootstro-content="The Options Panel changes based on the visualization that you've selected. Here, you can do things such as filter the results by country and product or even change the level of detail shown in the visualization." data-toggle="tooltip" data-bootstro-placement="left">

          <div id="ui_bottom" style="bottom: 0px; height:50px;">
            <div id="key" style="padding: 5px 0px 2px 5px;"></div>
          </div>
          <div class="row">
            {% if app_name != "product_space" %}
            <div class="vizControl col-md-4">
              <span class="definition" style="font-weight:bold;">Product Class:</span>
              <div class="btn-group" id="viz_apps" data-toggle="buttons" style="margin-top:0px; margin-right:20px; height:34px;">
                <label class="btn btn-default {% if prod_class == "sitc4" %}active{% endif %}">
                  <input type="radio" name="product_class" value="sitc4"> SITC4
                </label>
                 <label class="btn btn-default {% if prod_class == "hs4" %}active{% endif %}">
                  <input type="radio" name="product_class" value="hs4"> HS4
                </label>
              </div>
            </div>
            {% endif %}
            {% if app_name != "product_space" and app_name != "rings" and app_name != "map" %}          
              <div class="vizControl col-md-4" >
                  <span class="definition" style="font-weight:bold;">Detail Level:</span>
                  <div id="level_details" class="btn-group" data-toggle="buttons" style="margin-top:0px; margin-right:20px">
                    <label class="btn btn-default btn-detail {% if app_name == "stacked" %} active {% endif %}">
                      <input type="radio" name="level_detail" value="nesting_0" onchange="nest_drop_report(this.value);"> Low
                    </label>
                    {% if app_type == "casy" or app_type == "ccsy" %}
                    <label class="btn btn-default btn-detail">
                      <input type="radio" name="level_detail" value="nesting_1" onchange="nest_drop_report(this.value);" > Mid
                    </label>
                    {% endif %}
                    <label class="btn btn-default btn-detail {% if app_name != "stacked" %} active {% endif %}">
                      <input type="radio" name="level_detail" value="nesting_2" onchange="nest_drop_report(this.value);"> Hi
                    </label>
                  </div>  
                </div>
            {% endif %}

            {% if app_name != "product_space" and app_name != "rings"%}     
              <div class="vizControl col-md-4" >
                <span class="definition" style="font-weight:bold;">Trade Flow:</span>
                <div class="btn-group flow-net-gross" data-toggle="buttons" style="margin-top:0px; margin-right:20px">
                  <label class="btn btn-default btn-detail {% if trade_flow == "import" or trade_flow == "export" %} active{% endif %}">
                    <input type="radio" value="gross" onchange="$('.flow-net-gross').children().eq(1).removeClass('active'); $(this).parent().addClass('active');update_viz();"> Gross
                  </label>
                  <label class="btn btn-default btn-detail {% if trade_flow == "net_import" or trade_flow == "net_export" %} active{% endif %}">
                    <input type="radio" value="net" onchange="$('.flow-net-gross').children().eq(0).removeClass('active'); $(this).parent().addClass('active');update_viz();"> Net
                  </label>
                </div>
              </div>
            {% endif %}   
          </div>         
          {% if app_name == "stacked" %}  
          
          <style type="text/css">.contentInner{height:300px;} #timeline{min-height: 227px}</style>
          <div>

          <div id="stacked_controls" style="float:left; width:100%; ">
          
          <div class="row">
            <div class="vizControl col-md-4">
              <span class="definition" style="font-weight:bold;">Labels:</span>
              <div class="btn-group" data-toggle="buttons" style="margin-top:0px; margin-right:20px">
                <label class="btn btn-default active">
                  <input type="radio" id="true" name="labels" checked="checked">On
                </label>
                <label class="btn btn-default">
                  <input type="radio" id="false" name="labels" >Off
                </label>
              </div> 
            </div> 
            <div class="vizControl col-md-4">
            <span class="definition" style="font-weight:bold;">Layout:</span>
              <div class="btn-group" data-toggle="buttons" style="margin-top:0px; margin-right:20px">
                <label class="btn btn-default active">
                  <input type="radio" id="value" name="layout" checked="checked">Value
                </label>

                <label class="btn btn-default">
                  <input type="radio" id="share" name="layout">Share
                </label>
              </div> 
            </div> 

            <div class="vizControl col-md-4">
            <span class="definition" style="font-weight:bold;">Ordering:</span>
            <div class="btn-group" data-toggle="buttons" style="margin-top:0px; margin-right:20px">
              <label class="btn btn-default active">
                <input type="radio" id="community" name="order" checked="checked">Community
              </label>
              <label class="btn btn-default">
                <input type="radio" id="totals" name="order">Totals
              </label>
            </div>
            </div>  
          </div>
          {% if app_type != "sapy" %} 
          <div class="ui_bottom_row row">
  
              <div class="vizControl col-md-8">
                <span class="definition" style="font-weight:bold;">Adjust:</span>
<div class="btn-group" data-toggle="buttons" style="margin-top:0px; margin-right:20px">
              <label class="btn btn-default active">
                <input type="radio" id="current" name="capita" checked="checked"> Current
              </label>
              <label class="btn btn-default">
                <input type="radio" id="notpc_constant" name="capita"> Constant
              </label>
              <label class="btn btn-default">
                <input type="radio" id="pc_current" name="capita"> Per Capita Current
              </label>
              <label class="btn btn-default">
                <input type="radio" id="pc_constant" name="capita"> Per Capita Constant
              </label>
            </div>
              </div>
              <div class="vizControl col-md-4" style="float:left; margin-top:10px; position:relative; z-index:100;">
                <span class="definition" style="font-weight:bold; display:inline;">Highlight:</span>

                <span id="highlight">
             
                {% if app_type = "casy" or app_type = "ccsy" %}
                    <select data-placeholder="All Products" id="highlight_select" class="chosen-select-deselect" tabindex="-1" style="display:none;" onchange="highlight();" >
                      <option value=""></option>
                        {% if product_list %}
                          {% for p in product_list %}
                            {% if p.id == product.id %}
                          <option value="{{p.code}}" selected="selected">{{ p.name }}</option>
                            {% else %}
                          <option value="{{p.code}}">{{ p.name }}</option>
                            {% endif %}   
                          {% endfor %}
                        {% else %}  
                          {% with "explore/list_products_"|add:prod_class|add:".html" as template %}
                          {% include template %}
                          {% endwith %}
                        {% endif %}  
                    </select>

                 {% elif app_type = "csay" or app_type = "cspy" or app_type = "sapy" %}

                  <select data-placeholder="All Countries" id="highlight_select" class="chosen-select-deselect" tabindex="-1" style="display: none;" onchange="highlight();">

                  <option value=""></option>
                    {% if country1_list %}
                      {% for c in country1_list %}
                        <option value="{{c.name_3char|lower}}">{{ c.name }}</option>
                      {% endfor %}
                    {% else %}
                      {% include "explore/list_countries.html" %}
                    {% endif %}
                </select>

                {% endif %}     

                </span>

              </div>              

          </div> 

            {% endif %}
          
            </div>
          </div>  

          {% endif %}

          {% if app_name == "pie_scatter" %}
            <div class="product_class" style="float:left;">
              <span class="definition" style="font-weight:bold;">Y-Axis: </span>
              <div class="btn-group" id="pie_controls" data-toggle="buttons" style="margin-right:10px;">
                <label class="btn btn-default active" id="complexity" name="yvar" >
                  <input type="radio" id="complexity" name="yvar"> Complexity
                </label>
                <label class="btn btn-default" id="opp_gain" >
                  <input type="radio" id="opp_gain" name="yvar"> Opportunity Gain
                </label>
              </div>
            </div>
            <div class="product_class" style="float:left;">
              <span class="definition" style="font-weight:bold;">Spotlight: </span>
              <div class="btn-group" id="pie_controls" data-toggle="buttons" style="margin-right:20px;">

                <label class="btn btn-default active" id="complexity" name="yvar" >
                  <input type="radio" id="spot_off" name="pie_spot"> Off
                </label>
                <label class="btn btn-default" id="opp_gain" >
                  <input type="radio" id="spot_on" name="pie_spot"> On
                </label>

<!--                 <label class="btn btn-default">
                  <input type="radio">None
                </label>
                <label class="btn btn-default">
                  <input type="radio">Available
                </label>
                <label class="btn btn-default">
                  <input type="radio">Missing
                </label>    -->     

              </div>
            </div>
            <p style="clear:both">

          {% endif %}


          {% if app_name == "scatterplot" %}

            <div class="product_class" style="float:left;">
              <span class="definition" style="font-weight:bold;">X-Axis: </span>
              <div class="btn-group" id="pie_controls" data-toggle="buttons" style="margin-right:10px;">
                <label class="btn btn-default active" id="complexity" name="yvar" >
                  <input type="radio" id="complexity" name="yvar"> Distance
                </label>
                <label class="btn btn-default" id="opp_gain" >
                  <input type="radio" id="opp_gain" name="yvar"> PCI
                </label>
              </div>
            </div>

            <div class="product_class" style="float:left;">
              <span class="definition" style="font-weight:bold;">Y-Axis: </span>
              <div class="btn-group" id="pie_controls" data-toggle="buttons" style="margin-right:10px;">
                <label class="btn btn-default active" id="complexity" name="yvar" >
                  <input type="radio" id="complexity" name="yvar"> Complexity
                </label>
                <label class="btn btn-default" id="opp_gain" >
                  <input type="radio" id="opp_gain" name="yvar"> Opportunity Gain
                </label>
              </div>
            </div>

            <div class="product_class" style="float:left;">
            <span class="definition">Size by: </span>
            <div class="btn-group node_size" data-toggle="buttons" >
              <label type="button" class="btn btn-default active" value="none">
                <input type="radio" name="node_size" value="none" onchange="change_node_size(this.value)"> None
              </label> 
              <label type="button" class="btn btn-default" value="world_trade">
                <input type="radio" name="node_size" value="world_trade" onchange="change_node_size(this.value)"> World Trade
              </label>
            </div>
          </div>

       <p style="clear:both">

          <div class="product_class" style="float:left;">
            <span class="definition">Color by: </span>
            <div class="btn-group node_size" data-toggle="buttons" >
              <label type="button" class="btn btn-default active" value="none">
                <input type="radio" name="node_size" value="none" onchange="change_node_size(this.value)"> None
              </label> 
              <label type="button" class="btn btn-default" value="world_trade">
                <input type="radio" name="node_size" value="world_trade" onchange="change_node_size(this.value)"> Category
              </label>
            </div>
          </div>

            <div class="product_class" style="float:left;">
            <span class="definition">Scale: </span>
            <div class="btn-group node_size" data-toggle="buttons" >
              <label type="button" class="btn btn-default active" value="none">
                <input type="radio" name="node_size" value="none" onchange="change_node_size(this.value)"> Linear
              </label> 
              <label type="button" class="btn btn-default" value="world_trade">
                <input type="radio" name="node_size" value="world_trade" onchange="change_node_size(this.value)"> Log
              </label>
            </div>
          </div>

          {% endif %}

        <!-- Those used to be in the right side bar -->

          {% if app_name == "product_space" %}

          <div class="vizControl col-md-4">
            <span class="definition" style="font-weight:bold;">Product Class:</span>
            <div class="btn-group" id="viz_apps" data-toggle="buttons" style="margin-top:0px; margin-right:20px; height:34px;">
              <label class="btn btn-default {% if prod_class == "sitc4" %}active{% endif %}">
                <input type="radio" name="product_class" value="sitc4"> SITC4
              </label>
               <label class="btn btn-default {% if prod_class == "hs4" %}active{% endif %}">
                <input type="radio" name="product_class" value="hs4"> HS4
              </label>
            </div>
          </div>      
          <div class="vizControl col-md-4">          
            <span class="definition">Color by:</span>
            <div class="btn-group community" style="margin-right:20px;">
              <label type="button" class="btn btn-default active" value="category"> Category</label>
              <label type="button" class="btn btn-default disabled" value="category"> Community</label>
            </div>
          </div>
          <div class="vizControl col-md-4">
            <span class="definition">Size by: </span>
            <div class="btn-group node_size" data-toggle="buttons" >
              <label type="button" class="btn btn-default active" value="none">
                <input type="radio" name="node_size" value="none" onchange="change_node_size(this.value)"> None
              </label> 
              <label type="button" class="btn btn-default" value="world_trade">
                <input type="radio" name="node_size" value="world_trade" onchange="change_node_size(this.value)"> World Trade
              </label>
            </div>
          </div>


          <script>
            function updateRCA(v) {
              d3.select("#rca-threshold").text(v);
                  data.forEach(function(d){
                    d.active = d.rca >= v ? 1 : 0
                    return d;                
                  })

              d3.select("#viz").call(chart.highlight(""))
            }
          </script>

          <div class="btn-group col-md-4" id="viz_apps" data-toggle="buttons" style="margin-top:20px;">
          <span class="definition" style="font-weight:bold;">
            Filter by RCA Threshold:<span id="rca-threshold" style="font-weight:normal;">1</span>
          </span>

          </br>
          
          0 <input type="range" name="points" min="0" max="10" step=".1" value="1" id="set-rca-threshold" onchange="updateRCA(this.value);"> 10
          </div>

         {% endif %}







         {% if app_name == "map" %}

         <!-- TO BE IMPLEMENTED
          <b>Color scale: </b>
          <div class="btn-group product_class">
            <label type="button" class="btn btn-default {% if prod_class == "sitc4" %}active{% endif %}" value="sitc4">Linear</label>
            <label type="button" class="btn btn-default {% if prod_class == "hs4" %}active{% endif %}" value="hs4">Log</label>
          </div>
          -->

         {% endif %}


              <script>
              
                   function highlight(value) {

              {% if app_name == "product_space" or app_name == "rings" or app_type = "cspy" %}
         
                var v = value ? value : $("#highlight").find(":selected").val().trim();
                d3.select("#viz").call(chart.highlight([]));
                d3.select("#viz").call(chart.highlight(v));

                queryParameters['highlight'] = v;
                if(queryActivated)
                  updateURLQueryParameters();
            
              {% endif %}

              {% if app_name == "pie_scatter" or app_name == "tree_map" or app_name == "stacked"  %}

                var v = value ? value : $("#highlight").find(":selected").val().trim();

                {% if app_type = "casy" %}

                if(v.length>0)
                  d3.select("#viz").call(viz.solo([v]));
                else
                  d3.select("#viz").call(viz.solo([]));

                {% elif app_type = "csay" or app_type = "ccsy" or app_type = "cspy" or app_type = "sapy" %}

                d3.select("#viz").call(viz.solo(flat_data.filter(function(dd) { 
                  if(dd.abbrv.toLowerCase() == v)// && dd.year==year) 
                    return dd;
                }).map(function(ddd) { 
                    return ddd.id 
                })));

                {% elif app_type = "" %}

                {% endif %} 

                queryParameters['highlight'] = v;
  
                if(queryActivated)
                  updateURLQueryParameters();
                    {% endif %}
              }

              function reset_highlight() {

                $("#highlight").find(":selected").prop("selected", false);
                $("#highlight_select").trigger("chosen:updated");
                queryParameters["highlight"] = "";
                if(queryActivated)
                  updateURLQueryParameters();

              }
          
               </script>
              {% if app_name == "product_space" or app_name == "pie_scatter" or app_name == "tree_map" or app_name == "rings" %}
              <div class="col-span-4" style="float:left; margin-top:20px; position:relative; z-index:100;">
                <span class="definition" style="font-weight:bold; display:inline;">Highlight:</span>

                <span id="highlight">
             
                {% if app_type = "casy" or app_type = "ccsy" %}
                    <select data-placeholder="All Products" id="highlight_select" class="chosen-select-deselect" tabindex="-1" style="display:none;" onchange="highlight();" >
                      <option value=""></option>
                        {% if product_list %}
                          {% for p in product_list %}
                            {% if p.id == product.id %}
                          <option value="{{p.code}}" selected="selected">{{ p.name }}</option>
                            {% else %}
                          <option value="{{p.code}}">{{ p.name }}</option>
                            {% endif %}   
                          {% endfor %}
                        {% else %}  
                          {% with "explore/list_products_"|add:prod_class|add:".html" as template %}
                          {% include template %}
                          {% endwith %}
                        {% endif %}  
                    </select>

                 {% elif app_type = "csay" or app_type = "cspy" or app_type = "sapy" %}

                  <select data-placeholder="All Countries" id="highlight_select" class="chosen-select-deselect" tabindex="-1" style="display: none;" onchange="highlight();">

                  <option value=""></option>
                    {% if country1_list %}
                      {% for c in country1_list %}
                        <option value="{{c.name_3char|lower}}">{{ c.name }}</option>
                      {% endfor %}
                    {% else %}
                      {% include "explore/list_countries.html" %}
                    {% endif %}
                </select>

                {% endif %}     

                </span>

              </div>

              {% endif %}
	      </div>
        <br>
        <div id="moreOptions">
          <div id="moContainer">
            <div class="clone_loader">
              <span class="definition" style="font-weight:bold; margin-left:20px;">Display Mode:</span>
              <div class="btn-group flow-net-gross disabled" data-toggle="buttons" style="margin-top:0px; margin-left:20px">
                <label class="btn btn-default btn-detail {% if trade_flow == "import" or trade_flow == "export" %} active{% endif %}">
                  <input type="radio" name="display_mode" value="nesting_0" onchange="$('.flow-net-gross').children().eq(1).removeClass('active'); $(this).parent().addClass('active');update_viz();">Dynamic
                </label>
                <label class="btn btn-default btn-detail {% if trade_flow == "net_import" or trade_flow == "net_export" %} active{% endif %}">
                  <input type="radio" name="display_mode" value="nesting_2" onchange="$('.flow-net-gross').children().eq(0).removeClass('active'); $(this).parent().addClass('active');update_viz();">Static
                </label>
              </div> 

              <span class="definition" style="font-weight:bold; margin-left:20px;">Non-Significant Products:</span>
              <div class="btn-group flow-net-gross disabled" data-toggle="buttons" style="margin-top:0px; margin-left:20px">
                <label class="btn btn-default btn-detail {% if trade_flow == "import" or trade_flow == "export" %} active{% endif %}">
                  <input type="radio" name="non_products" value="nesting_0" onchange="$('.flow-net-gross').children().eq(1).removeClass('active'); $(this).parent().addClass('active');update_viz();">Show
                </label>
                <label class="btn btn-default btn-detail {% if trade_flow == "net_import" or trade_flow == "net_export" %} active{% endif %}">
                  <input type="radio" name="non_products" value="nesting_2" onchange="$('.flow-net-gross').children().eq(0).removeClass('active'); $(this).parent().addClass('active');update_viz();">Hide
                </label>
              </div> 
            </div>   

          </div>

        </div>
      </div>
      <footer>
      <div class="footerInner">

        <span>The Atlas of Economic complexity is a powerful interactive tool that enables users to visualize a country's total trade, track how these dynamics change over time and explore growth opportunities for more than a hundred countries worldwide.</span>
        <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">The Atlas of Economic complexity</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>. Current version: <a href="https://github.com/cid-harvard/atlas-economic-complexity">{{ VERSION }}</a>.
        <br />
        <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0 display:block;" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" /></a>
        <p style="clear:both"></p>
        <a style=" margin-left:150px; float:left;" href="http://www.hks.harvard.edu/centers/cid"><img src="media/img/all/logo_cid.png" alt="Center for International Development Logo"/></a>

        <div class="language_select" style="float:right; margin-right:150px;">

          <div class="text">
            Language:
          </div>
          <select>
            {% for lang in supported_langs %}
            <option style="" value="{{lang.0.code}}" {% if lang.0.code == LANGUAGE_CODE %} selected="selected" {% endif %}>{{lang.0.name_local}}</option>
            {% endfor %}
          </select> 
        </div>

      </div>

    </footer>        
         <!--<p id="showMore"><i class='fa fa-caret-down'> More Options</i></p>-->
      </div>  

       {% endif %}

      <!-- The right pane -->
      <div id="tool_pane" class="bootstro" data-bootstro-title="Sharing Panel" data-bootstro-content="The Sharing Panel allows you to export the current visualization through social media, email, or even create a 'story' and post it to our site." data-toggle="tooltip" data-bootstro-placement="left">
      {% if isbrowsemode %}
      {% else %}
      <div id= "createStoryPlaceHolder">
        <h4 id="sidebar-create-story" class="tooltipbs" data-toggle="tooltip" data-placement="top" title="Create stories" style="border-bottom: solid 1px #999; font-family:'PT Sans Narrow',Helvetica,Arial; font-size:95%; font-weight:500; margin: 10px 0px; padding: 0 0 2px 0; text-align:center;">Create-a-Story</h4>
        
    		<span class="glyphicon glyphicon-plus-sign tooltipbs" style="color:rgb(60, 59, 55);"data-placement="right" data-toggle="tooltip" {% if not iscreatemode %} title="Create a new story" onclick="showCreateStoryDialog()" {% endif %}  {% if iscreatemode %}  style="color:rgb(60, 59, 55)" title="Story is under construction!" {% endif %}></span>
        <!--<span class="glyphicon glyphicon-list-alt tooltipbs" data-placement="right" data-toggle="tooltip" title="Browse existing stories"  onclick="window.location.assign('stories/');"></span>-->

        {% if iscreatemode %}
          <span class="glyphicon glyphicon-plus tooltipbs" data-placement="right" data-toggle="tooltip" onclick="openCreateChapterDialog()" title="Add a new chapter"></span>
          <span class="glyphicon glyphicon-stop tooltipbs" data-placement="right" data-toggle="tooltip" onclick="endStory()" title="End the story" style="margin-left: 4px"></span>
        {% endif %}   

        <br/>
        <br/>
      </div>
      {% endif %}   
       
    <div id="shareThisPlaceholder">
        <h4 style="border-bottom: solid 1px #999; font-family:'PT Sans Narrow',Helvetica,Arial; font-size:95%; font-weight:500;">Share</h4>

        <a href="#" id="fbShare" class="addthis_button_facebook" data-placement="right" data-toggle="tooltip" title="Share this page with Facebook">
          <i class="fa fa-facebook fa-lg"></i>
        </a>

        <a class="addthis_button_twitter">
          <i class="fa fa-twitter fa-lg"></i>
        </a>

        <a class="addthis_button_google_plusone_share" >
          <i class="fa fa-google-plus fa-lg"></i>
        </a>

        <a class="addthis_button_email">
          <i class="fa fa-envelope fa-lg"></i>
        </a>

      </div> 
      {% if isbrowsemode %}
      {% else %}   
	<div class="control_container" id="download">
          <h4 style="border-bottom: solid 1px #999; font-family:'PT Sans Narrow',Helvetica,Arial; font-size:95%; font-weight:500; margin: 0; padding: 0 0 2px 0; ; margin: 10px 0px;  text-align:center; margin-left:-5px; width:40px">{% trans "Download" %}</h4>
        <a class="pdf" href="#"><img src="{{ STATIC_URL }}img/app/download.png" /> PDF</a>
          <a class="svg" href="#"><img src="{{ STATIC_URL }}img/app/download.png" /> SVG</a>
         <a class="png" href="#"><img src="{{ STATIC_URL }}img/app/download.png" /> PNG</a>
         <!-- <a class="csv" href="#"><img src="/{{ STATIC_URL }}img/app/download.png" /> CSV</a>-->
       </div>
	<form class="download" method="POST" action="download/">
      {% csrf_token %}
      <input type="hidden" name="url" value="" />
      <input type="hidden" name="title" value="" />
      <input type="hidden" name="format" value="svg" />
      <input type="hidden" name="content" value="" />
    </form>
  <!--  <div id = "downloadPlaceholder" >
    
        <h4 style="border-bottom: solid 1px #999; font-family:'PT Sans Narrow',Helvetica,Arial; font-size:95%; font-weight:500; margin: 0; padding: 0 0 2px 0; margin: 10px 0px;  text-align:center; margin-left:-5px; width:40px;">Download</h4>    

        <div class="control_container tooltipbs" id="download" style="pointer-events: none; cursor: default;" data-placement="right" data-toggle="tooltip" title="Not Available">
      
          <span class="glyphicon glyphicon-save" style="margin:5px; font-size:18px; color:lightgray"></span> 
         <!-- <a class="pdf" href="#" style="font-size:14px; color:lightgray; margin:5px; text-align:center;">PDF</a>
          <a class="svg" href="#" style="font-size:14px; color:lightgray; margin:4px; text-align:center;">SVG</a>-->
          <!--<a href="{% url observatory.views.download %}" class="png" style="font-size:14px; color:lightgray; margin:4px; text-align:center;">PNG</a>
         <!-- <a class="csv" href="#" style="font-size:14px; color:lightgray; margin:5px; text-align:center;">CSV</a>
      
         <a class="text" href="#" style="font-size:14px; color:lightgray; margin:3px; text-align:center;"> <span>{% trans "Data" %}</span></a>

        </div>

      -->

    
        <h4 style="border-bottom: solid 1px #999; font-family:'PT Sans Narrow',Helvetica,Arial; font-size:95%; font-weight:500; position:relative;left:-2px">Feedback</h4>
    
        <a id="feedbackPlaceholder" href="https://docs.google.com/forms/d/1lj1okNNN4U7O6207dJwxG6i0Yp_NqH1mKFADW_rurfE/viewform?entry.1903449278&entry.1131927011&entry.49173428&entry.1847748354={{ VERSION }}" target="_blank">
          <i class="fa fa-comment fa-lg"></i>
        </a>

        
        {% if displayviz %}
        <div id="downloadPlaceholder">
          <span class="dlOption"><a href="{{ displayImage }}"><i class="fa fa-download"></i></a><p>PNG</p></span>
<!--      <span class="dlOption"><a href="#"><i class="fa fa-download"></i></a><p>SVG</p></span>
          <span class="dlOption"><a href="#"><i class="fa fa-download"></i></a><p>PDF</p></span>
          <span class="dlOption"><a href="#"><i class="fa fa-download"></i></a><p>TEXT</p></span> -->
        </div>
        {% endif %}

    </div>
  
    {% endif %}
       
      </div> <!-- END Right pane -->

    </div> <!-- END #main -->

    <canvas style="display: none; overflow:hidden;" id="canvas" width="750px" height="520px"></canvas>
     
  </div> <!-- END #container -->




  <!-- The JavaScript -->
  <!-- Libraries -->
  <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script> 
  <script type="text/javascript" src="media/js/libs/helpbox.js"></script>

  <script src="{{ STATIC_URL }}js/libs/d3/d3.v3.min.js" charset="utf-8"></script>

  <script src="//s7.addthis.com/js/300/addthis_widget.js"></script>

  <script src="{{ STATIC_URL }}js/libs/bootstrap/js/bootstrap.js"></script>
  <script src="{{ STATIC_URL }}js/libs/bootstro/bootstro.min.js"></script>
  <script src="{{ STATIC_URL }}js/libs/chosen/chosen.jquery.js" ></script>

  <!-- App -->
  <script src="{{ STATIC_URL }}js/explore/general.js?{{ VERSION }}"></script>
  <script src="{{ STATIC_URL }}js/story/createStory.js?{{ VERSION }}"></script> 
  <script src="{{ STATIC_URL }}js/explore/key.js?{{ VERSION }}"></script>
  <script src="{{ STATIC_URL }}js/explore/timeline.js?{{ VERSION }}"></script>
  <script src="{{ STATIC_URL }}js/explore/controls.js?{{ VERSION }}"></script>
  <script src="{{ STATIC_URL }}js/apps/related.js?{{ VERSION }}"></script>
  <script src="{{ STATIC_URL }}js/libs/toastr/toastr.min.js"></script>

<!--
    <script src="{{ STATIC_URL }}js/libs/vizwiz/lib/modernizr.custom.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/general.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/utils.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/tooltip.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/utils.slider.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/viz/viz.js"></script>
-->
  <script src="{{ STATIC_URL }}js/libs/d3plus/lib/modernizr.custom.js"></script>
  <script src="{{ STATIC_URL }}js/libs/d3plus/src/general.js"></script>
  <script src="{{ STATIC_URL }}js/libs/d3plus/src/utils.js"></script>
  <script src="{{ STATIC_URL }}js/libs/d3plus/src/tooltip.js"></script>

  {% if app_name != "map" %}

    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/utils.slider.js"></script>

    {% if app_name != "scatterplot" %}

    <script src="{{ STATIC_URL }}js/libs/d3plus/src/viz/viz.js"></script>

      {% if app_name == "tree_map" %}<script src="{{ STATIC_URL }}js/libs/d3plus/src/viz/tree_map.js"></script>{% endif %}
      {% if app_name == "stacked" %}<script src="{{ STATIC_URL }}js/libs/d3plus/src/viz/stacked.js"></script>{% endif %}
      {% if app_name == "pie_scatter" %}<script src="{{ STATIC_URL }}js/libs/d3plus/src/viz/pie_scatter.js"></script>{% endif %}
      {% if app_name == "product_space" %}<script src="{{ STATIC_URL }}js/libs/d3plus/src/viz/network.js"></script>{% endif %}
      {% if app_name == "map" %}<!-- <script src="media/js/libs/d3plus/src/viz/geo_map.js"></script>-->{% endif %}
      {% if app_name == "rings" %}<script src="{{ STATIC_URL }}js/libs/d3plus/src/viz/rings.js"></script>{% endif %}

    {% elif app_name == "scatterplot" %}

      <script src="{{ STATIC_URL }}js/libs/d3plus/d3plus.v1.2.4.js"></script>

    {% endif %}

  {% endif %}

  {% if app_name == "map" %}

    <script src="{{ STATIC_URL }}js/libs/vizwiz/lib/modernizr.custom.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/general.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/utils.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/tooltip.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/utils.slider.orig.js"></script>
    <script src="{{ STATIC_URL }}js/libs/vizwiz/src/viz/viz.js"></script>
    <script src="{{ STATIC_URL }}js/apps/map.js"></script>

  {% endif %}

  {% if app_name == "rankings" %}

    <script src="media/js/libs/sorttable/sorttable.js"></script>
  
  {% endif %}


  <script src="{{ STATIC_URL }}js/explore/viz_general.js"></script> 

  <!-- Glossary -->
  <div id="glossary" style="display:none;">
    {% include "about/glossary_text.html" %}
  </div>

  <script>
    $("#glossary h4").each(function(index) {
        if($("#glossary").length > 0) {
          var word = $(this).text();
          var definition = $("#glossary").find("p")[index].innerHTML;

          $(".definition").each(function () {
            // Update all instances of that word in the content page with mouse over def.
            var html = $(this).html();
            html = html.replace(new RegExp(word, 'g'), '<font class="definition trigger-link" data-container="body" data-toggle="popover" data-placement="top" data-content="'+definition+'" title="<b>'+word+'</b>">'+word+'</font>');
            $(this).html(html);
           $(this).children().popover({ html: true, trigger: "hover", delay: { show: 1000, hide: 100, title: "word"}});

          });
        }  
    });

  </script> 
        <script type="text/javascript">
        clicked = false;
        $("#showMore").click(function(){
          if(clicked == false){
            $(this).addClass("moreActive");
            $(this).html("<i class='fa fa-caret-up'> Less Options</i> ");
            clicked = true;
          }else{
            $(this).removeClass("moreActive");
            $(this).html("<i class='fa fa-caret-down'> More Options");
            clicked = false;
          }
          $("#moreOptions").slideToggle(100);
        });
      </script>
  {% include "story/init_story.html" %}


  <script>
  
  // variables from server
  var app,
    app_types = ["tree_map", "stacked", "product_space", "rings", "pie_scatter", "map"],
    app_type ="{{app_type}}",
    warning = "{{warning}}",
    is_alert = "{{alert}}",
    api_uri = "{{api_uri}}",
    year =  "{{year}}",
    app_name = "{{app_name}}",
    years_available = {{years_available|safe}},
    trade_flow = "{{trade_flow}}",
    country1 = "{{country1}}",
    country2 = "{{country2}}",
    product = "{{product}}",
    item_type = "{{item_type}}",
    prod_or_partner = "{{prod_or_partner}}",
    lang= "{{lang}}",
    embed=false,
		d = "{{redesign_api_uri}}",
    year_start = "{{year_start}}",
    year_end = "{{year_end}}",
    product_code = "{{product_code}}",
    prod_class = "{{prod_class}}",
    previous_page = "{{previous_page}}",
    previous_image = "{{ STATIC_URL }}media/img/empty_static.png",
    static_url = "{{STATIC_URL}}";

  // Use chosen plugin to make dropdowns look fancy
  $(".dropdown_container select").chosen()
  $(".nesting select").chosen()
  // language select dropdown
  $(".language_select select").chosen();
  $(".language_select .chzn-search").hide();
  $(".language_select select").chosen().change(function(){
    // set session data to new language
    var language = $(this).val();
    window.location = "/set_language/"+language+"/";
  });
  

  // Variables from query string
  var queryParameters = {}, queryString = location.search.substring(1),
      re = /([^&=]+)=([^&]*)/g, m, queryActivated = false;
   
  // Creates a map with the query string parameters
  while (m = re.exec(queryString)) {
      queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
  }

  // Add new parameters or update existing ones
  queryParameters['prod_class'] = "{{prod_class}}";
  queryParameters['details_treemap'] = queryParameters['details_treemap'] || 2;
  queryParameters['cat_id'] = queryParameters['cat_id'] || "";
  queryParameters['cont_id'] = queryParameters['cont_id'] || "";
  //queryParameters['trade_flow'] = queryParameters['trade_flow'] || "net";
  queryParameters['highlight'] = queryParameters['highlight'] || "";

  function updateURLQueryParameters() {
    history.replaceState({}, "Title", window.location.origin+window.location.pathname+"?"+$.param(queryParameters));
  }


  if(queryActivated) {
    updateURLQueryParameters();

    // Put once the visualization is loaded
    $("#highlight_select").find('[value="'+queryParameters['highlight']+'"]').prop("selected", true);
    $("#highlight_select").trigger("chosen:updated")
    $("#highlight_select").find('[value="'+queryParameters['highlight']+'"]').prop("selected", true);
    $("#highlight_select").find('[value="'+queryParameters['highlight']+'"]').prop("selected", true);

//    $("input[name='level_detail']").prop("selected", false);

    
    //$(".btn-detail").prop("selected", false);
    //$("input[name='level_detail'][value='nesting_0']").prop("selected", true);
     
  }


  // Dynamically update the interface based on queryParameters values
  if(app_type=="tree_map") {
    d3.selectAll("input[name='level_detail']").property("checked", false)
    d3.selectAll("input[value='nesting_"+queryParameters['details_treemap']+"']").property("checked", true)
  }

  // set active link in top nav for current page
  var current_page = "explore";
  $("nav ul a").each(function(i, el){
    if($(el).text().toLowerCase() == current_page){
      $(el).addClass("current");
    }
  })

  // Check to see if the title overflows (in the case of long product names)
  function isOverflowed(element){
      return element.scrollHeight > element.clientHeight || element.scrollWidth > element.clientWidth;
  }
  
  var title = d3.select("#title")
  var shrink_size = 30;

  while(isOverflowed(title.node())) {
    $("#title").children().css("font-size", shrink_size+"px")
    shrink_size -= 1; 
  }

  // Page init scripts
  $(function () {

    $('.chosen-select').chosen();
    $('.chosen-select-deselect').chosen({ allow_single_deselect: true });

    $("#help").click(function(){
        bootstro.start(".bootstro",{
          finishButtonText: "Done"
        });
      });
 
    // Be sure we came back to the top of the page
    $(this).scrollTop(0);
    
    $(".chosen-select").chosen(); 
    $('.chosen-container').css('width', '150px');
    $('#country1_select_chosen').css('width', '170px');
    //$('#country1_select_chosen').css('font-size', '18px');    
    $('#year1_select_chosen').css('width', '60px');
    $('#year2_select_chosen').css('width', '80px');


    $('#country_trade_partner_select_chosen').css('width', '140px');
    $('#country_product_select_chosen').css('width', '140px');

    $('.chosen-select-deselect').chosen({ allow_single_deselect: true });

    $("#country1 select").change(function() {
      $("#country1_select_chosen .chosen-single span").css("background", "url('{{ STATIC_URL }}img/icons/flag_"+$(this).val()+".png') no-repeat");
      $("#country1_select_chosen .chosen-single span").css("background-size", "25px");
      $("#country1_select_chosen .chosen-single span").css("padding-left", "30px");
      $("#country1_select_chosen .chosen-single span").css("margin-top", "-2px");
      $("#country1_select_chosen .chosen-single span").css("color", "black");
    });

    $("#country-trade-partner select").change(function() {
      $("#country_trade_partner_select_chosen .chosen-single span").css("background", "url('{{ STATIC_URL }}img/icons/flag_"+$(this).val()+".png') no-repeat");
      $("#country_trade_partner_select_chosen .chosen-single span").css("background-size", "25px");
      $("#country_trade_partner_select_chosen .chosen-single span").css("padding-left", "30px");
      $("#country_trade_partner_select_chosen .chosen-single span").css("margin-top", "-2px");
    });

  // For some reason, $("#country1_select_chosen select").trigger("chosen:updated"); does not work
  $("#country1_select_chosen .chosen-single span").css("background", "url('{{ STATIC_URL }}img/icons/flag_"+$("#country1 select").val()+".png') no-repeat");
  $("#country1_select_chosen .chosen-single span").css("background-size", "25px");
  $("#country1_select_chosen .chosen-single span").css("padding-left", "30px");
  $("#country1_select_chosen .chosen-single span").css("margin-top", "-2px");

  $("#country1_select_chosen .chosen-results").hover(function() {
    $("#country1_select_chosen .chosen-results").css("color", "black");
  });

  $("#country_trade_partner_select_chosen .chosen-single span").css("background", "url('{{ STATIC_URL }}img/icons/flag_"+$("#country-trade-partner select").val()+".png') no-repeat");
  $("#country_trade_partner_select_chosen .chosen-single span").css("background-size", "25px");
  $("#country_trade_partner_select_chosen .chosen-single span").css("padding-left", "30px");
  $("#country_trade_partner_select_chosen .chosen-single span").css("margin-top", "-2px");

  $('#myTab a').click(function (e) {
    e.preventDefault()
    $(this).tab('show')
  })

  $('label[value=map]').click(function() { return update_viz("map"); } );   
  $('label[value=tree_map]').click(function() { return update_viz("tree_map"); } );
  $('label[value=stacked]').click(function() { return update_viz("stacked"); } );
  $('label[value=scatterplot]').click(function() { return update_viz("scatterplot"); } );
  $('label[value=rankings]').click(function() { return update_viz("rankings"); } );

  //To display visualization in full screen, while viewing stories
  var contentWidth=$("#content").width();

  // Call the original and let is handle the stuff - trying again
  build_viz_app_original(api_uri, contentWidth, 520);

});
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-41291966-1', 'harvard.edu');
    ga('send', 'pageview');
  </script>
            
   {% include "story/body_story.html" %}

<!-- Activates tooltips /////////////////////////////////////////////////////////////////// -->

<script type="text/javascript" src="../media/js/explore/tooltips.js"></script>
<script type="text/javascript" src="../media/js/libs/tipsy/tipsy.jquery.js"></script>
<script type='text/javascript'>
  $(function(){$('button[title]').tipsy({gravity: 'w', delayIn: 500});});
  $(function(){$('label[title]').tipsy({gravity: 'n', delayIn: 500});});  
</script>

  <script type="text/javascript">

    if(previous_page == "http://atlas.cid.harvard.edu" || previous_page == "http://atlas.cid.harvard.edu/beta" || previous_page == "None" || previous_page == "http://127.0.0.1:8000/"){
      previous_image = "{{ STATIC_URL }}img/default.png";
    } else if(previous_image == "{{ STATIC_URL }}img/empty_static.png"){
        $("#historyTab").css("display", "none");
    } else{
        previous_image = "http://atlas.cid.harvard.edu{{ displayImage }}"; 
        $("#historySlide").attr("href", previous_page);      
    }

    $("#historySlide, #historyOverlay").css("background-image", "url("+previous_image+")");

    $("#historySlide").mouseenter(function(){
      $("#historyOverlay").show();
    });

    $("#historySlide").mouseleave(function(){
      $("#historyOverlay").hide();
    });
  </script>
</body>
  {% include "story/story_forms.html" %}
</html>
